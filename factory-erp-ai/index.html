<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>60" Fabric ERP</title>

<style>
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto;
  background:#0b1320;
  color:#fff;
  display:flex;
  flex-direction:column;
  height:100vh;
}
header{
  background:#0f1b33;
  padding:12px;
  text-align:center;
  font-weight:600;
  font-size:18px;
  box-shadow:0 2px 8px rgba(0,0,0,.4);
  position:relative;
}
#printBtn{
  position:absolute;
  right:12px;
  top:8px;
  background:#22c55e;
  border:none;
  padding:6px 14px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
  cursor:pointer;
}
#chat{
  flex:1;
  overflow-y:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.msg{
  max-width:80%;
  padding:10px 14px;
  border-radius:14px;
  line-height:1.4;
  white-space:pre-line;
}
.user{background:#2563eb;align-self:flex-end}
.bot{background:#1f2937;align-self:flex-start}

#inputArea{
  position:sticky;
  bottom:0;
  background:#0f1b33;
  padding:10px;
  display:flex;
  gap:8px;
}
#q{
  flex:1;
  padding:12px;
  border-radius:25px;
  border:none;
  outline:none;
  font-size:15px;
}
button{
  background:#22c55e;
  border:none;
  color:white;
  padding:0 18px;
  border-radius:25px;
  font-weight:600;
}
#suggest{
  display:flex;
  gap:6px;
  padding:6px;
  overflow-x:auto;
}
.sug{
  background:#1e293b;
  padding:6px 12px;
  border-radius:20px;
  font-size:13px;
  cursor:pointer;
  white-space:nowrap;
}

/* ✅ NEW DROPDOWN SUGGESTION */
#dropdown{
  position:absolute;
  bottom:70px;
  left:10px;
  right:10px;
  background:#1e293b;
  border-radius:12px;
  display:none;
  max-height:200px;
  overflow-y:auto;
  box-shadow:0 10px 25px rgba(0,0,0,.5);
  z-index:999;
}
.drop-item{
  padding:10px;
  border-bottom:1px solid #334155;
  cursor:pointer;
}
.drop-item:last-child{border-bottom:none}
.drop-item:hover{background:#334155}
</style>
</head>

<body>

<header>
60" Fabric ERP
<button id="printBtn" onclick="printChat()">Print</button>
</header>

<div id="chat"></div>

<div id="suggest"></div>
<div id="dropdown"></div>

<div id="inputArea">
<input id="q" placeholder="প্রশ্ন লিখুন... যেমন: sill 590" />
<button onclick="send()">Send</button>
</div>

<script>
const chat=document.getElementById("chat");
const suggest=document.getElementById("suggest");
const dropdown=document.getElementById("dropdown");
const input=document.getElementById("q");

let lastQuery="";

const quick=["sill 590","3 feb cpb","total dyeing","party RB design"];
const commands=[
"sill 590","3 feb cpb","total dyeing",
"party RB design","today",
"cpb per day","jigger per day"
];

/* QUICK CHIPS */
quick.forEach(t=>{
  const d=document.createElement("div");
  d.className="sug";
  d.innerText=t;
  d.onclick=()=>{input.value=t;send();};
  suggest.appendChild(d);
});

/* DROPDOWN SUGGEST */
input.addEventListener("input",function(){
  const val=this.value.toLowerCase();
  dropdown.innerHTML="";
  if(!val){dropdown.style.display="none";return;}

  const match=commands.filter(c=>c.includes(val));
  if(match.length===0){dropdown.style.display="none";return;}

  match.forEach(m=>{
    const d=document.createElement("div");
    d.className="drop-item";
    d.innerText=m;
    d.onclick=function(){
      input.value=m;
      dropdown.style.display="none";
      input.focus();
    };
    dropdown.appendChild(d);
  });

  dropdown.style.display="block";
});

function add(text,type){
  const div=document.createElement("div");
  div.className="msg "+type;
  div.innerText=text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

async function send(){
  const text=input.value.trim();
  if(!text) return;

  lastQuery=text;
  dropdown.style.display="none";

  add(text,"user");
  input.value="";
  add("...","bot");
  const loading=chat.lastChild;

  try{
    const r=await fetch("/factory/api/ask",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({question:text})
    });

    const j=await r.json();
    loading.innerText=j.reply||"No reply";

  }catch{
    loading.innerText="Server error";
  }
}

/* PRINT SAME AS BEFORE */
function printChat(){
  const bots=document.querySelectorAll(".bot");
  if(bots.length===0) return;

  const lastReport=bots[bots.length-1].innerText;
  const dateTime=new Date().toLocaleString();

  const win=window.open("","","width=900,height=700");
  win.document.write(`
  <html>
  <head>
  <style>
  @page { size:A4 portrait; margin:20mm; }
  body{font-family:Arial;padding:30px;}
  .company{text-align:center;font-size:28px;font-weight:bold;}
  .address{text-align:center;font-size:14px;margin-top:4px;}
  .erp{text-align:center;font-size:16px;font-weight:bold;margin-top:6px;}
  .line{height:2px;background:#000;width:70%;margin:12px auto;}
  .title{text-align:center;font-size:20px;font-weight:bold;margin:10px 0;}
  .footer{margin-top:60px;font-size:13px;display:flex;justify-content:space-between;}
  </style>
  </head>
  <body>

  <div class="company">Sukhy Dyeing & Finishing Mills Ltd.</div>
  <div class="address">Kurerpar, Shekherchor, Narsingdi.</div>
  <div class="erp">Sukhy ERP</div>
  <div class="line"></div>

  <div class="title">60" Fabric Dyeing Report</div>

  <div><b>Query:</b> ${lastQuery}<br><b>Generated:</b> ${dateTime}</div>
  <hr>
  ➤ ${lastReport.replace(/\n/g,"<br>➤ ")}

  <div class="footer">
    <div>Prepared By: Mehedi Hasan<br>Developed By: Mehedi Hasan</div>
    <div>Signature: ___________________________</div>
  </div>

  </body>
  </html>
  `);
  win.document.close();
  win.print();
}
</script>

</body>
</html>
